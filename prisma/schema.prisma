generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Otp_Tokens {
  internal_id       Int          @id @default(autoincrement())
  email             String?      @db.VarChar(50)
  phone             String?      @db.VarChar(20)
  devicefingerprint String?
  otp_code          String       @db.VarChar(6)
  action            String       @db.VarChar(50)
  status            OtpStatus    @default(PENDING)
  expires_at        DateTime     @db.Timestamp(6)
  attempts          Int          @default(0)
  blocked_at        DateTime?    @db.Timestamp(6)
  verified_at       DateTime?    @db.Timestamp(6)
  createdAt         DateTime     @default(now())
  User_device       User_device? @relation(fields: [devicefingerprint], references: [fingerprint])

  @@index([email], type: Hash)
  @@index([phone], type: Hash)
}

model RefreshTokens {
  internal_id        Int         @id @default(autoincrement())
  device_fingerprint String
  userId             Int
  tokenHash          String
  isRevoked          Boolean     @default(false)
  revoked_at         DateTime?   @db.Timestamp(6)
  expiresAt          DateTime
  createdAt          DateTime    @default(now())
  User_device        User_device @relation(fields: [device_fingerprint], references: [fingerprint])
  users              users       @relation(fields: [userId], references: [internal_id])

  @@unique([device_fingerprint, userId])
  @@index([userId])
}

model User_Device_UserId {
  internal_id Int         @id @default(autoincrement())
  deviceid_fk String
  userid_fk   Int
  User_device User_device @relation(fields: [deviceid_fk], references: [fingerprint], onDelete: Cascade)
  users       users       @relation(fields: [userid_fk], references: [internal_id], onDelete: Cascade)

  @@unique([deviceid_fk, userid_fk])
}

model User_device {
  fingerprint        String               @id
  create_at          DateTime             @default(now()) @db.Timestamp(6)
  device_name        String               @db.VarChar(100)
  isblocked          Boolean              @default(false)
  blocked_at         DateTime?            @db.Timestamp(6)
  blocked_until      DateTime?            @db.Timestamp(6)
  block_count        Int                  @default(0)
  forever_block      Boolean              @default(false)
  Otp_Tokens         Otp_Tokens[]
  RefreshTokens      RefreshTokens[]
  User_Device_UserId User_Device_UserId[]
  users_audit        users_audit[]
}

model users {
  internal_id        Int                  @id @default(autoincrement())
  nationalId         String?              @unique @db.VarChar(255)
  public_id          String               @unique @default(uuid())
  phone              String?              @unique @db.VarChar(20)
  email              String               @unique @db.VarChar(50)
  password           String               @db.VarChar(255)
  birth_of_date      String               @db.VarChar(10)
  email_verified     Boolean              @default(false)
  phone_verified     Boolean              @default(false)
  name               String               @db.VarChar(50)
  email_verified_at  DateTime?            @db.Timestamp(6)
  phone_verified_at  DateTime?            @db.Timestamp(6)
  isblocked          Boolean              @default(false)
  blocked_at         DateTime?            @db.Timestamp(6)
  blocked_until      DateTime?            @db.Timestamp(6)
  block_count        Int                  @default(0)
  Forever_block      Boolean              @default(false)
  createdAt          DateTime             @default(now()) @db.Timestamp(6)
  updatedAt          DateTime             @db.Timestamp(6)
  RefreshTokens      RefreshTokens[]
  User_Device_UserId User_Device_UserId[]
  users_audit        users_audit[]

  @@index([email], type: Hash)
  @@index([phone], type: Hash)
}

model users_audit {
  internal_id        Int          @id @default(autoincrement())
  phone              String?      @db.VarChar(20)
  email              String       @db.VarChar(255)
  password           String       @db.VarChar(255)
  is_absher          Boolean
  birth_of_date      DateTime     @db.Date
  email_verified     Boolean
  phone_verified     Boolean
  name               String       @db.VarChar(100)
  userid_fk          Int
  change_at          DateTime     @db.Timestamp(6)
  action_type        String       @db.VarChar(50)
  change_count       Int
  period_end         String       @db.VarChar(50)
  device_fingerprint String?
  User_device        User_device? @relation(fields: [device_fingerprint], references: [fingerprint])
  users              users        @relation(fields: [userid_fk], references: [internal_id], onDelete: Cascade)

  @@index([device_fingerprint])
  @@index([email], type: Hash)
  @@index([phone], type: Hash)
}

enum OtpStatus {
  PENDING
  VERIFIED
  BLOCKED
  EXPIRED
}


